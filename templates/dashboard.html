{% extends 'base.html' %}
{% block content %}

<h2 class="text-2xl font-semibold text-center mb-6 dark:text-gray-100">ðŸ“Š Dashboard</h2>

<!-- Tarjetas resumen -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 text-center">
    <h6 class="text-sm text-gray-500 dark:text-gray-400">Ingresos</h6>
    <h3 class="text-2xl font-bold text-green-500">{{ ingresos|currency }}</h3>
  </div>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 text-center">
    <h6 class="text-sm text-gray-500 dark:text-gray-400">Gastos</h6>
    <h3 class="text-2xl font-bold text-red-500">{{ gastos|currency }}</h3>
  </div>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 text-center">
    <h6 class="text-sm text-gray-500 dark:text-gray-400">Pagos</h6>
    <h3 class="text-2xl font-bold text-blue-500">{{ pagos|currency }}</h3>
  </div>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 text-center">
    <h6 class="text-sm text-gray-500 dark:text-gray-400">Balance</h6>
    <h3 class="text-2xl font-bold text-indigo-500">{{ balance|currency }}</h3>
  </div>
</div>

<!-- Movimientos recientes -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-8 overflow-x-auto">
  <div class="flex justify-between items-center mb-3">
    <h5 class="text-lg font-semibold dark:text-gray-100">Movimientos recientes</h5>
    <div class="flex gap-2">
      <a href="{{ url_for('export_csv') }}" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm transition">
        Exportar CSV
      </a>
      <a href="{{ url_for('export_pdf') }}" class="px-3 py-1 bg-gray-700 hover:bg-gray-800 text-white rounded-lg text-sm transition">
        Exportar PDF
      </a>
    </div>
  </div>

  <table class="w-full text-sm text-left text-gray-600 dark:text-gray-300">
    <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
      <tr>
        <th class="px-3 py-2 text-center">Fecha</th>
        <th class="px-3 py-2 text-center">Tipo</th>
        <th class="px-3 py-2 text-center">CategorÃ­a</th>
        <th class="px-3 py-2 text-center">DescripciÃ³n</th>
        <th class="px-3 py-2 text-center">Monto</th>
        <th class="px-3 py-2 text-center">Debe</th>
        <th class="px-3 py-2 text-center" colspan="2">AcciÃ³n</th>
      </tr>
    </thead>
    <tbody>
      {% for m in movimientos %}
      <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
        <td class="text-center px-3 py-2">{{ m.fecha }}</td>
        <td class="text-center px-3 py-2 capitalize">{{ m.tipo }}</td>
        <td class="text-center px-3 py-2">{{ m.categoria }}</td>
        <td class="text-center px-3 py-2">{{ m.descripcion }}</td>
        <td class="text-center px-3 py-2">{{ m.monto|currency }}</td>
        <td class="text-center px-3 py-2">{{ m.falta|currency }}</td>
        <td class="text-center px-3 py-2">
          <a href="{{ url_for('movimiento_detail', mov_id=m.id) }}" class="px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs">
            Ver
          </a>
        </td>
        <td>
          <form method="POST" action="{{ url_for('movimiento_delete', mov_id=m.id) }}" class="inline" onsubmit="return confirm('Â¿Seguro que deseas eliminar este movimiento?');">
            <button type="submit" class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
              Eliminar
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Deudas por persona -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-8 overflow-x-auto">
  <h5 class="text-lg font-semibold mb-3 dark:text-gray-100">Deudas por persona</h5>
  <table class="w-full text-sm text-left text-gray-600 dark:text-gray-300">
    <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
      <tr>
        <th class="px-3 py-2 text-center">Persona</th>
        <th class="px-3 py-2 text-center">Monto Debe</th>
        <th class="px-3 py-2 text-center">Monto Pagado</th>
        <th class="px-3 py-2 text-center">Le Deben</th>
        <th class="px-3 py-2 text-center">Balance Neto</th>
      </tr>
    </thead>
    <tbody>
      {% for item in deudas %}
      <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
        <td class="px-3 py-2 text-center">{{ item.person.name }}</td>
        <td class="px-3 py-2 text-center">{{ item.debe | currency }}</td>
        <td class="px-3 py-2 text-center">{{ item.pagado | currency }}</td>
        <td class="px-3 py-2 text-center font-semibold 
                    {% if item.le_deben > 0 %} text-green-600 
                   {% elif item.le_deben < 0 %} text-red-600 
                   {% elif item.le_deben == 0 %} text-gray-500
                   {% else %} text-gray-500 {% endif %}">
        {{ item.le_deben | currency }}</td>
        <td class="px-3 py-2 text-center font-semibold 
                   {% if item.balance > 0 %} text-green-600 
                   {% elif item.balance < 0 %} text-red-600 
                   {% elif item.balance == 0 %} text-gray-500
                   {% else %} text-gray-500 {% endif %}">
          {{ item.balance | currency }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mt-4 text-sm dark:text-gray-100">
    <p>ðŸ’¸ Deben en total: <strong>{{ total_deuda | currency }}</strong></p>
  </div>
</div>


<!-- GrÃ¡ficas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
    <h5 class="text-lg font-semibold mb-2 dark:text-gray-100">Ingresos vs Gastos</h5>
    <canvas id="chartIngresosGastos" class="w-full h-64"></canvas>
  </div>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
    <h5 class="text-lg font-semibold mb-2 dark:text-gray-100">Gastos por CategorÃ­a</h5>
    <canvas id="chartCategorias" class="w-full h-64"></canvas>
  </div>
</div>

<script>
  const ingresosGastosData = {{ ingresos_gastos_data|tojson }};
  const categoriasData = {{ categorias_data|tojson }};
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

{% endblock %}

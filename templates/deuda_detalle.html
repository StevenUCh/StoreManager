{% extends 'base.html' %}
{% block content %}

<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 max-w-5xl mx-auto mt-6">

  <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">
    Movimiento #{{ mov.id }} ‚Äî {{ mov.tipo|capitalize }} ‚Äî 
    <span class="text-gray-800 dark:text-gray-200">{{ mov.monto | default(0) | currency }}</span>
  </h3>

  <p class="text-gray-600 dark:text-gray-300 mb-1">
    Categor√≠a: <strong>{{ mov.categoria }}</strong> ¬∑ Fecha: <strong>{{ mov.fecha }}</strong>
  </p>

  {% if mov.descripcion %}
    <p class="text-gray-700 dark:text-gray-200 mb-1">{{ mov.descripcion }}</p>
  {% endif %}

  {% if pagador_todo %}
    <p class="text-gray-600 dark:text-gray-300 mb-4">
      Se deben a <strong>{{ pagador_todo.person.name }}</strong> el valor de: 
      <strong>{{ deuda_total | default(0) | currency }}</strong>
    </p>
  {% endif %}


  <!-- Bot√≥n para agregar abono -->
  <div class="mb-4">
    <button type="button" onclick="openModal('modalAbono')" 
            class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold transition">
      ‚ûï Registrar Abono
    </button>
  </div>

  <!-- Tabla de detalles por persona -->
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm text-left border-collapse">
      <thead class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
        <tr>
          <th class="p-2">Persona</th>
          <th class="p-2 text-center">Pag√≥ todo</th>
          <th class="p-2 text-right">Monto</th>
          <th class="p-2 text-right">Total abonado</th>
          <th class="p-2 text-right">Saldo pendiente</th>
          <th class="p-2 text-center">Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for d in mov.detalles %}
        <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
          <td class="p-2">{{ d.person.name }}</td>
          <td class="p-2 text-center">
          {% if d.pago_todo %}
            <span class="px-2 py-1 rounded-md bg-green-600 text-white">Pago</span>
          {% else %}
            -
          {% endif %}
        </td>

          <td class="p-2 text-right">{{ d.monto | default(0) | currency }}</td>
          <td class="p-2 text-right">{{ d.abonado | default(0) | currency }}</td>
          <td class="p-2 text-right">{{ (d.monto - d.abonado) | default(0) | currency }}</td>
          <td class="p-2 text-center">
            <span class="px-2 py-1 rounded-md {{ 'bg-green-600 text-white' if d.estado=='Pagado' else 'bg-red-200 text-red-800' }}">
              {{ d.estado }}
            </span>
          </td>
        </tr>

        {% if d.abonos %}
        <tr>
          <td colspan="5" class="p-2 bg-gray-50 dark:bg-gray-800">
            <ul class="list-disc pl-6 mt-2 space-y-1">
              {% for a in d.abonos %}
              <li class="flex justify-between items-center">
                <div>
                  {{ a.fecha.strftime('%Y-%m-%d %H:%M') }} ‚Äî 
                  <span class="font-semibold text-green-600 dark:text-green-400">
                    {{ a.monto | default(0) | currency }}
                  </span>
                </div>
                <form 
                  action="{{ url_for('delete_abono', abono_id=a.id) }}" 
                  method="POST" 
                  onsubmit="return confirm('¬øSeguro que deseas eliminar este abono?');"
                  class="inline"
                >
                  <button 
                    type="submit" 
                    class="text-red-500 hover:text-red-700 text-sm font-medium ml-4"
                    title="Eliminar abono"
                  >
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </form>
              </li>
              {% endfor %}
            </ul>
          </td>
        </tr>
        {% endif %}

        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-4 text-sm">
    <a href="{{ url_for('dashboard') }}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
      ‚Üê Volver a dashboard
    </a>
  </div>
  <div class="mt-4 text-sm">
    <a href="{{ url_for('movimientos') }}" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
      ‚Üê Volver a movimientos
    </a>
  </div>
</div>

<!-- Modal para registrar abono -->
<div id="modalAbono" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 w-96 relative">
    <h4 class="text-lg font-bold text-indigo-600 dark:text-indigo-400 mb-4">Registrar Abono</h4>
    <form id="formAbono" method="POST" action="{{ url_for('abonar', mov_id=mov.id) }}">
      <div class="mb-3">
        <label class="block font-semibold text-gray-700 dark:text-gray-300 mb-1">Persona</label>
        <select name="detalle_id" class="w-full rounded-md border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white p-2" required>
          <option value="" disabled selected>Selecciona una persona</option>
          {% for d in mov.detalles %}
          <option value="{{ d.id }}">{{ d.person.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="block font-semibold text-gray-700 dark:text-gray-300 mb-1">Monto a abonar</label>
        <input type="text" name="monto" placeholder="0.00" required
               class="w-full rounded-md border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white p-2 text-right"
               oninput="formatCurrency(this)"
               autocomplete="off">
      </div>
      <div class="mb-3">
        <label class="block font-semibold text-gray-700 dark:text-gray-300 mb-1">Fecha</label>
        <input type="datetime-local" name="fecha" required
               class="w-full rounded-md border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white p-2 text-right"
               autocomplete="off">
      </div>
      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeModal('modalAbono')" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg"> Cancelar </button>

        <button type="submit" 
                class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold">Registrar</button>
      </div>
    </form>
  </div>
</div>

{% if abono and movimientos_deudor %}
<div id="modalAbonoIndirecto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 w-full max-w-md relative">
    <h4 class="text-lg font-bold text-indigo-600 dark:text-indigo-400 mb-4">
      Asignar abono en nombre de {{ pagador_todo.person.name }}
    </h4>
    {% if abono_monto %}
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
        üí∞ Abono disponible: <strong>{{ abono_monto | default(0) | currency }}</strong>
      </p>
    {% endif %}

    <div class="mb-3 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
      <p><strong>Abono original:</strong> {{ abono.monto | default(0) | currency }}</p>
      <p>
        <strong>Saldo disponible:</strong>
        <span id="saldoAbonoDisponible" class="text-green-600 font-semibold">
          {{ (abono.monto - (abono.monto_aplicado or 0)) | default(0) | currency }}
        </span>
      </p>
    </div>

    <form id="formAbonoIndirecto" method="POST" action="{{ url_for('asignar_abono_indirecto', abono_id=abono.id) }}">
      <div class="mb-3">
        <label class="block font-semibold text-gray-700 dark:text-gray-300 mb-1">Selecciona el movimiento</label>
        <select id="selectMovimiento" name="movimiento_id"
                class="w-full rounded-md border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white p-2"
                required onchange="mostrarDetalleMovimiento()">
          <option value="" disabled selected>Elige un movimiento</option>
          {% for m in movimientos_deudor %}
          <option value="{{ m.movimiento_id }}"
                  data-categoria="{{ m.categoria }}"
                  data-descripcion="{{ m.descripcion or 'Sin descripci√≥n' }}"
                  data-falta="{{ m.falta }}">
            Movimiento #{{ m.movimiento_id }} ‚Äî {{ m.categoria }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div id="detalleMovimiento" class="hidden mt-3 bg-gray-100 dark:bg-gray-700 rounded-lg p-3 text-sm">
        <p><strong>Categor√≠a:</strong> <span id="catMov"></span></p>
        <p><strong>Descripci√≥n:</strong> <span id="descMov"></span></p>
        <p><strong>Debe:</strong> <span id="faltanteMov" class="text-red-600 font-semibold"></span></p>
      </div>

      <div id="campoAbono" class="hidden mt-3">
        <label class="block font-semibold text-gray-700 dark:text-gray-300 mb-1">Monto a abonar</label>
        <input type="text" id="montoAcum" name="montoAcum" placeholder="0.00" required
        class="w-full rounded-md border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-white p-2 text-right"
        oninput="formatCurrency(this)"
        autocomplete="off">
        <small id="limiteInfo" class="text-gray-500 text-sm"></small>
      </div>

      <div class="flex justify-end space-x-2 mt-4">
        <button type="button" onclick="closeModal('modalAbonoIndirecto')" 
                class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg">
          Cancelar
        </button>
        <button type="submit" 
                class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold hidden"
                id="btnAplicar">
          Aplicar Abono
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('hidden'); // oculta
    // opcional: modal.classList.remove('flex'); si quieres eliminar flex
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('selectMovimiento');
  const detalleDiv = document.getElementById('detalleMovimiento');
  const montoAcumInput = document.getElementById('montoAcum');
  const btnAplicar = document.getElementById('btnAplicar');
  const campoAbono = document.getElementById('campoAbono');
  const limiteInfo = document.getElementById('limiteInfo');

  // üí∞ Monto disponible del abono original
  {% if abono %}
    const saldoDisponible = parseFloat({{ (abono.monto - (abono.monto_aplicado or 0)) | tojson }});
  {% else %}
    const saldoDisponible = 0;
  {% endif %}

  window.mostrarDetalleMovimiento = function() {
    const selected = select.options[select.selectedIndex];
    if (!selected) return;

    const categoria = selected.dataset.categoria;
    const descripcion = selected.dataset.descripcion;
    const falta = parseFloat(selected.dataset.falta || 0);

    // Mostrar detalle
    document.getElementById('catMov').textContent = categoria;
    document.getElementById('descMov').textContent = descripcion;
    document.getElementById('faltanteMov').textContent = falta.toFixed(2);
    detalleDiv.classList.remove('hidden');
    campoAbono.classList.remove('hidden');
    btnAplicar.classList.remove('hidden');

    // üîí L√≠mite m√°ximo = menor entre la deuda y el saldo disponible del abono original
    const limite = Math.min(falta, saldoDisponible);
    montoAcumInput.max = limite;
    limiteInfo.textContent = `Monto m√°ximo permitido: $${limite.toFixed(2)}`;

    montoAcumInput.value = '';
  };

  // üîç Validar el monto ingresado y convertir texto a n√∫mero sin comas
  montoAcumInput?.addEventListener('input', () => {
    let valorStr = montoAcumInput.value.replace(/,/g, ''); // quitar comas
    let value = parseFloat(valorStr) || 0;
    const max = parseFloat(montoAcumInput.max) || 0;

    // Evita que el usuario supere el l√≠mite
    if (value > max) {
      value = max;
      montoAcumInput.value = value;
    }
  });

  // Mostrar el modal autom√°ticamente si existe
  const modal = document.getElementById('modalAbonoIndirecto');
  if (modal) modal.classList.remove('hidden');
});


function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex'); 
  }
}

function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
}

function formatCurrency(input) {
  let value = input.value.replace(/,/g, '').replace(/[^\d.]/g, '');
  if(!value){ input.value=''; return; }
  const parts = value.split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  input.value = parts.join('.');
}
</script>

{% endblock %}
